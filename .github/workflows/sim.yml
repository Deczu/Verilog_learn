name: Multi-Simulator CI (Icarus → Verilator fallback)

on:
  push:
    branches:
      - "**"
  pull_request:

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      testbenches: ${{ steps.find.outputs.list }}
    steps:
      - uses: actions/checkout@v4

      - id: find
        run: |
          echo "Szukam testbenchów..."
          TB_LIST=$(find . -type f \( -name "*_tb*.sv" -o -name "*_tb*.v" \) | sort | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "Znalezione TB: $TB_LIST"
          echo "list=$TB_LIST" >> $GITHUB_OUTPUT

  simulate:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tb: ${{ fromJson(needs.discover.outputs.testbenches) }}
    steps:
      - uses: actions/checkout@v4

      # ────────────────────────────────────────────────
      # 1. Najpierw Icarus Verilog
      # ────────────────────────────────────────────────
      - name: Install Icarus Verilog
        run: sudo apt-get update && sudo apt-get install -y iverilog

      - name: Build & run with Icarus
        id: icarus
        continue-on-error: true
        run: |
          echo "Testbench: ${{ matrix.tb }}"
          DIR=$(dirname "${{ matrix.tb }}")
          SV_FILES=$(find "$DIR" -type f \( -name "*.sv" -o -name "*.v" \) | sort | tr '\n' ' ')
          echo "Pliki: $SV_FILES"
          
          iverilog -g2012 -o sim-icarus.out $SV_FILES
          vvp sim-icarus.out || true

      # ────────────────────────────────────────────────
      # 2. Fallback: Verilator – tylko gdy Icarus zawiódł
      # ────────────────────────────────────────────────
      - name: Install Verilator (fallback)
        if: steps.icarus.outcome == 'failure'
        run: sudo apt-get update && sudo apt-get install -y verilator

      - name: Build & run with Verilator (fallback)
        if: steps.icarus.outcome == 'failure'
        run: |
          echo "Icarus failed → fallback na Verilator dla ${{ matrix.tb }}"
          
          DIR=$(dirname "${{ matrix.tb }}")
          SV_FILES=$(find "$DIR" -type f \( -name "*.sv" -o -name "*.v" \) | sort | tr '\n' ' ')
          
          # Czyszczenie starego katalogu (unikanie cache/clock skew)
          rm -rf obj_dir
          
          verilator \
            --prefix Vsim \
            --binary \
            --trace-fst \
            --build \
            -j 0 \
            -Wall \
            -Wno-fatal \
            -Wno-EOFNEWLINE \
            -Wno-DECLFILENAME \
            -Wno-VARHIDDEN \
            -Wno-UNUSEDSIGNAL \
            -Wno-BLKSEQ \
            --timescale "1ns/1ns" \
            $SV_FILES
          
          ./obj_dir/Vsim || true

      # ────────────────────────────────────────────────
      # Artifacty – zbieramy niezależnie od wyniku
      # ────────────────────────────────────────────────
      - name: Sanitize artifact name
        id: sanitize
        run: |
          CLEAN_NAME=$(echo "${{ matrix.tb }}" | sed 's|^\./||' | tr '/.' '_' | sed 's/__*/_/g' | sed 's/_$//')
          echo "clean=$CLEAN_NAME" >> $GITHUB_OUTPUT

      - name: Upload simulation results
        uses: actions/upload-artifact@v4
        with:
          name: sim-${{ steps.sanitize.outputs.clean }}
          path: |
            sim-*.out
            obj_dir/*
            **/*.vcd
            **/*.fst
            **/*.log
          if-no-files-found: ignore
          retention-days: 7